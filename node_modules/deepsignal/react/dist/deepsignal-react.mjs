import"@preact/signals-react";import{useMemo as e}from"react";import{Signal as t,signal as r,computed as n}from"@preact/signals-core";import{useSignals as s}from"@preact/signals-react/runtime";const a=new WeakMap,o=new WeakMap,l=new WeakMap,c=new WeakSet,i=new WeakMap,f=/^\$/,g=Object.getOwnPropertyDescriptor;let p=!1;const u=e=>{if(!M(e))throw new Error("This object can't be observed.");return o.has(e)||o.set(e,w(e,d)),o.get(e)},h=(e,t)=>{p=!0;const r=e[t];try{p=!1}catch(e){}return r};function y(e){return c.add(e),e}const w=(e,t)=>{const r=new Proxy(e,t);return c.add(r),r},m=()=>{throw new Error("Don't mutate the signals directly.")},v=e=>(t,s,c)=>{var i;if(p)return Reflect.get(t,s,c);let u=e||"$"===s[0];if(!e&&u&&Array.isArray(t)){if("$"===s)return l.has(t)||l.set(t,w(t,b)),l.get(t);u="$length"===s}a.has(c)||a.set(c,new Map);const h=a.get(c),y=u?s.replace(f,""):s;if(h.has(y)||"function"!=typeof(null==(i=g(t,y))?void 0:i.get)){let e=Reflect.get(t,y,c);if(u&&"function"==typeof e)return;if("symbol"==typeof y&&R.has(y))return e;h.has(y)||(M(e)&&(o.has(e)||o.set(e,w(e,d)),e=o.get(e)),h.set(y,r(e)))}else h.set(y,n(()=>Reflect.get(t,y,c)));return u?h.get(y):h.get(y).value},d={get:v(!1),set(e,n,s,l){var c;if("function"==typeof(null==(c=g(e,n))?void 0:c.set))return Reflect.set(e,n,s,l);a.has(l)||a.set(l,new Map);const p=a.get(l);if("$"===n[0]){s instanceof t||m();const r=n.replace(f,"");return p.set(r,s),Reflect.set(e,r,s.peek(),l)}{let t=s;M(s)&&(o.has(s)||o.set(s,w(s,d)),t=o.get(s));const a=!(n in e),c=Reflect.set(e,n,s,l);return p.has(n)?p.get(n).value=t:p.set(n,r(t)),a&&i.has(e)&&i.get(e).value++,Array.isArray(e)&&p.has("length")&&(p.get("length").value=e.length),c}},deleteProperty(e,t){"$"===t[0]&&m();const r=a.get(o.get(e)),n=Reflect.deleteProperty(e,t);return r&&r.has(t)&&(r.get(t).value=void 0),i.has(e)&&i.get(e).value++,n},ownKeys:e=>(i.has(e)||i.set(e,r(0)),i._=i.get(e).value,Reflect.ownKeys(e))},b={get:v(!0),set:m,deleteProperty:m},R=new Set(Object.getOwnPropertyNames(Symbol).map(e=>Symbol[e]).filter(e=>"symbol"==typeof e)),k=new Set([Object,Array]),M=e=>"object"==typeof e&&null!==e&&k.has(e.constructor)&&!c.has(e),P=t=>(s(),e(()=>u(t),[]));export{u as deepSignal,h as peek,y as shallow,P as useDeepSignal};//# sourceMappingURL=deepsignal-react.mjs.map
